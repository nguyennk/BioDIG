'''
	ApplicationfortheImageEditoroftheDOME
	URL:/or/index.html
	
	Author:AndrewOberlin
	Date:August5,2012
'''
from renderEngine.ApplicationBase import ApplicationBase
from django.http import HttpResponseRedirect
from django.core.urlresolvers import reverse
from django.views.decorators.csrf import csrf_exempt
import uuid
#from django.contrib.auth import authenticate,login
#from django.contrib.auth.models import User
#import random, string
from django.core.mail import EmailMultiAlternatives
from mycoplasma_home.views.pagelets.public.NavBarPagelet import NavBarPagelet
from mycoplasma_home.views.pagelets.public.ResetPasswordPagelet import ResetPasswordPagelet

class Application(ApplicationBase):
	def doProcessRender(self,request):
		self.success = -1
		self.login_value = 0
		self.message = ''
		if request.method=='POST':
			user_email=request.POST['email']
			self.message = 'Please check email to reset your password'
			#token = ''.join(random.choice(string.ascii_uppercase + string.digits) for n in range(20))
			token = uuid.uuid4()
			url = 'localhost/changePassword?user=%s' %(token)
			subject, from_email, to = 'Reset Password', 'rajeswari284@gmail.com',user_email
			text_content = ''						
			html_content = '<html><body><p>Please click the link below to reset your password</p><a href=%s>Click Here</a></body></html></p>' %(url)
			msg = EmailMultiAlternatives(subject, text_content, from_email, [to])
			msg.attach_alternative(html_content, "text/html")
			msg.send()
			
			args = {
				'title'	: 'Reset'
				}
		
			self.setApplicationLayout('public/base.html',args)
			navbarPagelet=NavBarPagelet()
			navbarPagelet.login_links(self.login_value)
			navbarPagelet.login_messages('')
			self.addPageletBinding('navBar',navbarPagelet)
			resetpasswordPagelet = ResetPasswordPagelet()
			resetpasswordPagelet.login_messages(self.message)
			self.addPageletBinding('center-1',resetpasswordPagelet)
		else:
			args = {
				'title'	: 'Reset'
				}
		
			self.setApplicationLayout('public/base.html',args)
			navbarPagelet=NavBarPagelet()
			navbarPagelet.login_links(self.login_value)
			navbarPagelet.login_messages('')
			self.addPageletBinding('navBar',navbarPagelet)
			resetpasswordPagelet = ResetPasswordPagelet()
			resetpasswordPagelet.login_messages(self.message)
			self.addPageletBinding('center-1',resetpasswordPagelet)
			#self.success = 1
			#password=request.POST['password']
			#user = User.objects.get(username=username)
			#user.set_password(password)
			#user.save()
			#newuser=authenticate(username=username,password=password)
			#if newuser is not None and newuser.is_active:
			#	login(request,newuser)
			#	self.success = 1
				
		
		
	def render(self,request):
		self.doProcessRender(request)
		if self.success == 1:
			return HttpResponseRedirect(reverse('mycoplasma_home.views.applications.public.Home.Application.renderAction'))
		else:
			return self.renderEngine.render(request)
	
@csrf_exempt
def renderAction(request):
	return Application().render(request)
